<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamVerse - Ultimate IPTV Experience</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/videojs-seek-buttons/dist/videojs-seek-buttons.css" rel="stylesheet">
    
    <script src="//cdn.jsdelivr.net/npm/@clappr/player@0.4.0/dist/clappr.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/mux.js@5.6.7/dist/mux.min.js"></script>
    <script src='//cdn.jsdelivr.net/npm/level-selector@latest/dist/level-selector.min.js'></script>
    <script src='//cdn.jsdelivr.net/npm/clappr-chromecast-plugin@latest/dist/clappr-chromecast-plugin.min.js'></script>
    <script src='//cdn.jsdelivr.net/npm/clappr-pip@latest/dist/clappr-pip.min.js'></script>
    <script src='//cdn.jsdelivr.net/npm/clappr-playback-rate-plugin@latest/dist/clappr-playback-rate-plugin.min.js'></script>
    <script src="//cdn.jsdelivr.net/npm/shaka-player@2.5.10/dist/shaka-player.compiled.min.js"></script>
    <script src="//cdn.jsdelivr.net/gh/clappr/dash-shaka-playback@latest/dist/dash-shaka-playback.external.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/cdnbye-shaka@latest"></script>

    <style>
        /* --- 1. THEME & GLOBAL STYLES --- */
        :root {
            --shadow-color: rgba(0, 0, 0, 0.5);
            --gradient-start: #1a1a2e;
            --gradient-end: #162447;
            --font-family: 'Poppins', sans-serif;
            --transition-speed: 0.3s;
            --border-radius: 12px;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        /* Dark Theme (Default) - Updated */
        body {
            --primary-bg: #101010;
            --secondary-bg: #1b1b1b;
            --tertiary-bg: #282828;
            --primary-text: #e0e0e0;
            --secondary-text: #b3b3b3;
            --accent-color: #7237df; /* A vibrant blue-purple */
            --accent-hover: #8e58f0;
            --border-color: #383838;
            --glow-color: #7237df;
        }

        /* Light Theme - Updated */
        body.light-theme {
            --primary-bg: #f0f2f5;
            --secondary-bg: #ffffff;
            --tertiary-bg: #e5e7eb;
            --primary-text: #333333;
            --secondary-text: #666666;
            --border-color: #d1d5db;
            --accent-color: #007bff;
            --accent-hover: #0056b3;
            --glow-color: #007bff;
            --gradient-start: #f5f5f5;
            --gradient-end: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --glass-bg: rgba(0, 0, 0, 0.05);
            --glass-border: rgba(0, 0, 0, 0.1);
        }

        /* Black & White Theme */
        body.bw-theme {
            --primary-bg: #000000;
            --secondary-bg: #111111;
            --tertiary-bg: #222222;
            --primary-text: #ffffff;
            --secondary-text: #cccccc;
            --accent-color: #ffffff;
            --accent-hover: #dddddd;
            --border-color: #444444;
            --glow-color: #ffffff;
            --shadow-color: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--primary-text);
            display: flex;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        
        #vanta-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: -1;
        }

        /* --- 2. LAYOUT --- */
        #sidebar {
            width: 260px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--glass-border);
            height: 100vh;
            position: fixed;
            left: 0; top: 0;
            transform: translateX(0);
            transition: transform var(--transition-speed) ease;
            z-index: 1000;
            display: flex; flex-direction: column;
        }
        #sidebar.collapsed { transform: translateX(-100%); }
        #sidebar.open { transform: translateX(0); }

        main {
            flex-grow: 1;
            margin-left: 260px;
            padding: 25px;
            transition: margin-left var(--transition-speed) ease;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height: 100vh;
            -webkit-overflow-scrolling: touch;
        }
        main.sidebar-collapsed { margin-left: 0; }
        
        /* --- 3. SIDEBAR --- */
        #sidebar-header {
            padding: 20px;
            font-size: 1.8rem;
            color: var(--accent-color);
            text-align: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        #category-list { 
            list-style: none; 
            flex-grow: 1; 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
        }
        #category-list a {
            display: flex; align-items: center; gap: 15px; padding: 14px 20px;
            color: var(--secondary-text); text-decoration: none;
            transition: all 0.2s; font-size: 1rem;
            border-left: 4px solid transparent;
        }
        #category-list a:hover { 
            background-color: var(--tertiary-bg); 
            color: var(--primary-text); 
            border-left-color: var(--accent-hover);
        }
        #category-list a.active {
            background-color: var(--tertiary-bg); 
            color: var(--primary-text);
            border-left-color: var(--accent-color);
        }
        #category-list a i { color: var(--accent-color); }
        #category-list a.active i { color: var(--primary-text); }

        /* --- 4. HEADER & CONTROLS --- */
        #main-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 30px; 
            gap: 15px; 
            flex-wrap: wrap; 
            flex-shrink: 0;
            position: sticky; /* NEW: Added sticky header */
            top: 0;
            background: var(--primary-bg); /* Match body background */
            z-index: 999;
            padding-bottom: 10px; /* Add some spacing */
        }
        #menu-toggle { 
            background: none; 
            border: none; 
            color: var(--primary-text); 
            font-size: 1.6rem; 
            cursor: pointer; 
        }
        #search-bar {
            flex-grow: 1; 
            padding: 12px 20px; 
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color); 
            border-radius: 50px;
            color: var(--primary-text); 
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        #search-bar:focus {
            border-color: var(--accent-color);
        }
        .header-controls { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .control-btn { 
            background: var(--tertiary-bg); 
            color: var(--primary-text); 
            border: none; 
            border-radius: 8px; 
            width: 44px; 
            height: 44px; 
            cursor: pointer; 
            font-size: 1rem; 
            transition: all 0.2s;
        }
        .control-btn:hover {
            transform: scale(1.05);
            background-color: var(--accent-color);
            color: #fff;
        }
        .control-btn.active { 
            background-color: var(--accent-color); 
            color: #fff; 
        }

        .theme-switch-wrapper, .lang-switch-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            height: 28px;
            width: 50px;
            cursor: pointer;
        }
        .lang-switch-wrapper .slider, .theme-switch-wrapper .slider {
            background-color: var(--tertiary-bg);
            border-radius: 34px;
            width: 100%;
            height: 100%;
            position: absolute;
            transition: .4s;
        }
        .lang-switch-wrapper .slider:before, .theme-switch-wrapper .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: var(--primary-text);
            transition: .4s;
            border-radius: 50%;
        }
        .lang-switch-wrapper.active .slider {
            background-color: var(--accent-color);
        }
        .lang-switch-wrapper.active .slider:before {
            transform: translateX(22px);
        }
        .lang-switch-label, .theme-switch-label {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 0.7rem;
            z-index: 1;
        }
        .lang-switch-label.bn {
            left: 5px;
        }
        .lang-switch-label.en {
            right: 5px;
            opacity: 0.5;
        }
        .lang-switch-wrapper.active .lang-switch-label.bn {
            opacity: 0.5;
        }
        .lang-switch-wrapper.active .lang-switch-label.en {
            opacity: 1;
        }
        .theme-switch-label.dark { left: 5px; }
        .theme-switch-label.light { right: 5px; opacity: 0.5; }
        .theme-switch-wrapper.active .theme-switch-label.dark { opacity: 0.5; }
        .theme-switch-wrapper.active .theme-switch-label.light { opacity: 1; }
        .theme-switch-wrapper.active .slider { background-color: var(--accent-color); }
        .theme-switch-wrapper.active .slider:before { transform: translateX(22px); }

        /* --- 5. PLAYER --- */
        #player-wrapper, #videojs-player-wrapper { 
            display: none; 
            margin-bottom: 30px; 
            flex-shrink: 0;
        }
        #artplayer-container, #videojs-container { 
            width: 100%; 
            aspect-ratio: 16 / 9; 
            background-color: #000; 
            border-radius: var(--border-radius); 
            overflow: hidden; 
            box-shadow: 0 15px 40px var(--shadow-color); 
        }
        #player-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* Video.js player specific styles */
        .video-js.vjs-16-9 {
            width: 100%;
            height: auto;
        }

        /* --- 6. CHANNEL DISPLAY --- */
        #channel-display h3 { 
            font-size: 1.8rem; 
            margin-bottom: 20px; 
            font-weight: 600;
            flex-shrink: 0;
        }
        #channel-grid { 
            display: grid; 
            gap: 25px; 
        }
        #channel-grid.grid-view { 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
        }
        .channel-card {
            background-color: var(--secondary-bg); 
            border-radius: var(--border-radius);
            cursor: pointer; 
            transition: all 0.3s ease;
            overflow: hidden; 
            border: 2px solid transparent; 
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .channel-card:hover { 
            transform: translateY(-5px) scale(1.02); 
            box-shadow: 0 10px 30px var(--shadow-color); 
            border-color: var(--accent-color);
        }
        .channel-card.playing { 
            border-color: var(--accent-color); 
            box-shadow: 0 0 20px var(--glow-color);
            animation: pulse-border 1.5s infinite;
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0px var(--glow-color); }
            100% { box-shadow: 0 0 15px 5px rgba(114, 55, 223, 0.4); }
        }
        
        body.bw-theme .channel-card.playing {
            animation: none;
            box-shadow: 0 0 20px var(--glow-color);
        }

        /* NEW: Channel Status Light */
        .channel-status-light {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 12px;
            height: 12px;
            background-color: gray;
            border-radius: 50%;
            z-index: 2;
        }
        .channel-card.working .channel-status-light {
            background-color: limegreen;
            box-shadow: 0 0 5px limegreen;
        }

        .channel-logo-container { 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 120px;
            background-color: var(--tertiary-bg); 
            padding: 15px; 
        }
        .channel-logo { 
            max-width: 80%; 
            max-height: 100%; 
            object-fit: contain; 
        }
        .channel-name { 
            padding: 15px 10px; 
            font-size: 1rem; 
            font-weight: 500;
            text-align: center; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            color: var(--primary-text); 
            background-color: var(--secondary-bg);
            border-top: 1px solid var(--border-color);
        }
        .favorite-icon { 
            position: absolute; 
            top: 12px; 
            right: 12px; 
            font-size: 1.3rem; 
            color: rgba(255,255,255,0.6); 
            z-index: 2; 
            transition: all 0.2s; 
        }
        .favorite-icon:hover { 
            transform: scale(1.2); 
            color: #fdd835; 
        }
        .favorite-icon.favorited { 
            color: #fdd835; 
        }
        .share-icon {
            position: absolute;
            top: 12px;
            left: 12px;
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.6);
            z-index: 2;
            transition: all 0.2s;
        }
        .share-icon:hover {
            transform: scale(1.2);
            color: var(--accent-hover);
        }
        #channel-grid.list-view { 
            grid-template-columns: 1fr; 
            gap: 15px; 
        }
        #channel-grid.list-view .channel-card { 
            display: flex; 
            align-items: center; 
            padding: 10px;
        }
        #channel-grid.list-view .channel-logo-container { 
            width: 70px; 
            height: 70px; 
            flex-shrink: 0; 
            border-radius: 8px;
            margin-right: 15px;
        }
        #channel-grid.list-view .channel-name { 
            flex-grow: 1; 
            text-align: left; 
            padding: 0;
            background: none;
            border: none;
        }
        #channel-grid.list-view .favorite-icon { 
            position: static; 
            margin-left: auto; 
            padding: 0 10px; 
        }
        
        /* --- 7. LOADER & STATUS --- */
        #loader { 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            padding: 50px; 
            text-align: center;
        }
        .spinner { 
            border: 4px solid var(--tertiary-bg); 
            border-top: 4px solid var(--accent-color); 
            border-radius: 50%; 
            width: 50px; 
            height: 50px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .status-message { 
            width: 100%; 
            text-align: center; 
            font-size: 1.2rem; 
            color: var(--secondary-text); 
        }
        
        /* NEW: Channel Checking Animation */
        .loading-text {
            margin-top: 20px;
            font-size: 1.2rem;
            color: var(--primary-text);
        }

        /* NEW: Circular Progress Bar */
        .progress-circle {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(closest-side, var(--primary-bg) 79%, transparent 80% 100%),
                        conic-gradient(var(--accent-color) 0%, transparent 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .progress-circle:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--secondary-bg);
            transform: translate(-50%, -50%);
            z-index: -1;
        }
        
        .progress-circle-text {
            color: var(--primary-text);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
        }

        /* --- 8. WELCOME POPUP & PLAYLIST MANAGER --- */
        .popup-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .popup-content {
            background: var(--secondary-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px var(--shadow-color);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .popup-overlay.show .popup-content {
            transform: scale(1);
        }
        .popup-content h2 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }
        .popup-content p {
            color: var(--secondary-text);
            margin-bottom: 25px;
        }
        .popup-content button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .popup-content button:hover {
            background: var(--accent-hover);
        }
        .popup-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 1.5rem;
            cursor: pointer;
        }
        #playlist-manager-popup {
            text-align: left;
        }
        #playlist-manager-popup h2 {
            text-align: center;
        }
        #playlist-manager-popup input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--tertiary-bg);
            color: var(--primary-text);
            box-sizing: border-box;
        }
        #playlist-manager-popup .form-group {
            margin-bottom: 15px;
        }
        #playlist-manager-popup label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        #playlist-manager-popup button {
            width: 100%;
            margin-top: 10px;
        }
        #playlist-manager-popup ul {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 15px;
        }
        #playlist-manager-popup li {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #playlist-manager-popup li:last-child {
            border-bottom: none;
        }
        #playlist-manager-popup li:hover {
            background-color: var(--tertiary-bg);
        }
        #playlist-manager-popup .delete-btn {
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 1rem;
            cursor: pointer;
        }
        #file-upload-label {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: var(--tertiary-bg);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #file-upload-label:hover {
            background-color: var(--accent-hover);
            color: #fff;
        }
        #m3u-file-input {
            display: none;
        }
        
        /* --- 9. MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            body { overflow-y: auto; }
            #sidebar { 
                transform: translateX(-100%); 
                width: 100%;
                border-right: none;
            }
            main { 
                margin-left: 0; 
                padding: 15px; 
                overflow-y: initial;
                height: auto;
            }
            #main-header {
                flex-wrap: wrap;
                justify-content: space-between;
                gap: 10px;
            }
            .header-controls {
                width: 100%;
                justify-content: flex-end;
            }
            #search-bar {
                order: 1;
                flex-grow: 1;
            }
            #menu-toggle {
                order: 0;
            }
            .channel-card {
                padding: 8px;
            }
            #channel-grid.grid-view { 
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            }
        }
    </style>
</head>
<body>

    <div id="vanta-bg"></div>
    
    <nav id="sidebar">
        <div id="sidebar-header" data-bn="StreamVerse">StreamVerse</div>
        <ul id="category-list"></ul>
        <div style="padding: 20px; border-top: 1px solid var(--border-color); flex-shrink: 0;">
            <a href="#" class="category-link" id="manage-playlist-btn"><i class="fa-solid fa-layer-group"></i> <span data-bn="প্লেলিস্ট ম্যানেজ করুন">Manage Playlists</span></a>
        </div>
    </nav>

    <main>
        <header id="main-header">
            <button id="menu-toggle"><i class="fa-solid fa-bars"></i></button>
            <input type="text" id="search-bar" placeholder="চ্যানেল, সিনেমা বা সিরিজ খুঁজুন...">
            <div class="header-controls">
                <button id="view-toggle-btn" class="control-btn" title="Toggle View"><i class="fa-solid fa-grip"></i></button>
                <button id="player-toggle-btn" class="control-btn" title="Toggle Player"><i class="fa-solid fa-video"></i></button>
                <div class="lang-switch-wrapper">
                    <span class="lang-switch-label bn">BN</span>
                    <span class="lang-switch-label en">EN</span>
                    <div class="slider"></div>
                </div>
                <div class="theme-switch-wrapper">
                    <span class="theme-switch-label dark"><i class="fa-solid fa-moon"></i></span>
                    <span class="theme-switch-label light"><i class="fa-solid fa-sun"></i></span>
                    <div class="slider"></div>
                </div>
            </div>
        </header>

        <section id="player-wrapper">
            <div id="artplayer-container"></div>
            <div id="player-controls">
                <button id="player-close-btn" class="control-btn" title="Close Player" data-bn="প্লেয়ার বন্ধ করুন"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </section>

        <section id="videojs-player-wrapper">
            <div id="videojs-container">
                <video id="my-player" class="video-js vjs-16-9 vjs-big-play-centered" controls preload="auto" data-setup='{"playbackRates": [0.5, 1, 1.5, 2]}'>
                </video>
            </div>
            <div id="player-controls">
                <button id="videojs-close-btn" class="control-btn" title="Close Player" data-bn="প্লেয়ার বন্ধ করুন"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </section>

        <section id="channel-display">
            <h3 id="current-category-title">All Channels</h3>
            <div id="channel-grid" class="grid-view">
                <div id="loader">
                    <div class="progress-circle">
                        <span class="progress-circle-text">0%</span>
                    </div>
                    <p class="loading-text" data-bn="চ্যানেল চেক করা হচ্ছে...">চ্যানেল চেক করা হচ্ছে...</p>
                </div>
            </div>
        </section>
    </main>
    
    <div id="welcome-popup" class="popup-overlay">
        <div class="popup-content">
            <h2 data-bn="StreamVerse এ স্বাগতম!">StreamVerse এ স্বাগতম!</h2>
            <p data-bn="আপনার প্রিয় চ্যানেলগুলো দেখতে উপভোগ করুন।">আপনার প্রিয় চ্যানেলগুলো দেখতে উপভোগ করুন।</p>
            <button id="close-popup" data-bn="শুরু করুন">শুরু করুন</button>
        </div>
    </div>
    
    <div id="playlist-manager-popup" class="popup-overlay">
        <div class="popup-content">
            <button class="popup-close-btn">&times;</button>
            <h2 data-bn="প্লেলিস্ট ম্যানেজ করুন">Manage Playlists</h2>
            <div class="form-group">
                <label for="playlist-name-input" data-bn="প্লেলিস্টের নাম">Playlist Name</label>
                <input type="text" id="playlist-name-input" placeholder="যেমন: My Channels">
            </div>
            <div class="form-group">
                <label for="playlist-url-input" data-bn="M3U/M3U8 URL">M3U/M3U8 URL</label>
                <input type="url" id="playlist-url-input" placeholder="URL পেস্ট করুন">
            </div>
            <div class="form-group">
                <label for="playlist-logo-input" data-bn="লোগো URL (ঐচ্ছিক)">Logo URL (Optional)</label>
                <input type="url" id="playlist-logo-input" placeholder="লোগোর URL পেস্ট করুন">
            </div>
            <button id="save-playlist-btn" data-bn="প্লেলিস্ট সেভ করুন">Save Playlist</button>
            <p style="text-align: center; margin: 15px 0;" data-bn="- অথবা -">- অথবা -</p>
            <label id="file-upload-label" for="m3u-file-input" data-bn="ফাইল আপলোড করুন">
                <i class="fa-solid fa-upload"></i> ফাইল আপলোড করুন
            </label>
            <input type="file" id="m3u-file-input" accept=".m3u,.m3u8">
            <h3 data-bn="সংরক্ষিত প্লেলিস্ট" style="margin-top: 30px;">Saved Playlists</h3>
            <ul id="saved-playlists-list"></ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
    <script src="https://vjs.zencdn.net/8.5.2/video.min.js"></script>
    <script src="https://unpkg.com/@videojs/http-streaming/dist/videojs-http-streaming.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/videojs-seek-buttons/dist/videojs-seek-buttons.min.js"></script>

    <script>
        // --- 1. CONFIGURATION & TRANSLATIONS ---
        const DEFAULT_M3U_URLS = [
            'https://raw.githubusercontent.com/biplob840c/tv/refs/heads/main/tv1',
            // Add your additional URLs here
            // 'https://example.com/another-playlist.m3u',
            // 'https://example.com/my-channels.m3u8'
        ];
        const ENABLE_3D_BACKGROUND = true;
        const WELCOME_MESSAGE_KEY = 'streamverse_welcome_shown';
        const LANGUAGE_KEY = 'streamverse_language';
        const THEME_KEY = 'streamverse_theme';
        const SAVED_PLAYLISTS_KEY = 'streamverse_saved_playlists';
        const PLAYER_KEY = 'streamverse_active_player';

        const translations = {
            bn: {
                searchPlaceholder: "চ্যানেল, সিনেমা বা সিরিজ খুঁজুন...",
                allChannels: "সব চ্যানেল",
                closePlayer: "প্লেয়ার বন্ধ করুন",
                welcomeTitle: "StreamVerse এ স্বাগতম!",
                welcomeText: "আপনার প্রিয় চ্যানেলগুলো দেখতে উপভোগ করুন।",
                getStarted: "শুরু করুন",
                all: "সব",
                favorites: "প্রিয়",
                recentlyWatched: "সম্প্রতি দেখা",
                managePlaylists: "প্লেলিস্ট ম্যানেজ করুন",
                playlistName: "প্লেলিস্টের নাম",
                playlistUrl: "M3U/M3U8 URL",
                playlistLogo: "লোগো URL (ঐচ্ছিক)",
                savePlaylist: "প্লেলিস্ট সেভ করুন",
                or: "- অথবা -",
                uploadFile: "ফাইল আপলোড করুন",
                savedPlaylists: "সংরক্ষিত প্লেলিস্ট",
                noChannelsFound: "এই ক্যাটাগরিতে কোনো চ্যানেল পাওয়া যায়নি।",
                playerToggleTitle: "প্লেয়ার পরিবর্তন করুন",
                viewToggleTitle: "ভিউ পরিবর্তন করুন",
                shareIconTitle: "চ্যানেল শেয়ার করুন",
                favIconTitle: "ফেভারিট লিস্টে যোগ করুন",
                channelCopySuccess: "চ্যানেলের লিংক কপি করা হয়েছে!",
                fetchError: "প্লেলিস্ট লোড করা যায়নি।",
                fileUploadSuccess: "প্লেলিস্ট ফাইল আপলোড সম্পন্ন হয়েছে।",
                urlSaved: "URL সেভ করা হয়েছে।",
                inputError: "দয়া করে একটি নাম এবং URL দিন।",
                checkingChannels: "চ্যানেল চেক করা হচ্ছে... (%c/%t)",
                checkingComplete: "সব চ্যানেল লোড হয়েছে।"
            },
            en: {
                searchPlaceholder: "Search for channels, movies or series...",
                allChannels: "All Channels",
                closePlayer: "Close Player",
                welcomeTitle: "Welcome to StreamVerse!",
                welcomeText: "Enjoy watching your favorite channels.",
                getStarted: "Get Started",
                all: "All",
                favorites: "Favorites",
                recentlyWatched: "Recently Watched",
                managePlaylists: "Manage Playlists",
                playlistName: "Playlist Name",
                playlistUrl: "M3U/M3U8 URL",
                playlistLogo: "Logo URL (Optional)",
                savePlaylist: "Save Playlist",
                or: "- OR -",
                uploadFile: "Upload File",
                savedPlaylists: "Saved Playlists",
                noChannelsFound: "No channels found in this category.",
                playerToggleTitle: "Toggle Player",
                viewToggleTitle: "Toggle View",
                shareIconTitle: "Share Channel",
                favIconTitle: "Add to favorites",
                channelCopySuccess: "Channel link copied!",
                fetchError: "Failed to load playlist.",
                fileUploadSuccess: "Playlist file uploaded successfully.",
                urlSaved: "URL saved successfully.",
                inputError: "Please provide a name and a URL.",
                checkingChannels: "Checking channels... (%c/%t)",
                checkingComplete: "All channels loaded."
            }
        };

        // --- 2. GLOBAL STATE ---
        let allChannels = [], clapprPlayer, videojsPlayer, vantaEffect;
        let favorites = JSON.parse(localStorage.getItem('streamverse_favorites')) || [];
        let recentlyPlayed = JSON.parse(localStorage.getItem('streamverse_recents')) || [];
        let savedPlaylists = JSON.parse(localStorage.getItem(SAVED_PLAYLISTS_KEY)) || DEFAULT_M3U_URLS.map((url, index) => ({
            name: `Default List ${index + 1}`,
            url: url
        }));
        let activePlayer = localStorage.getItem(PLAYER_KEY) || 'clappr';
        let currentView = 'grid';
        let currentLang = localStorage.getItem(LANGUAGE_KEY) || 'bn';
        let currentTheme = localStorage.getItem(THEME_KEY) || 'dark';

        // --- 3. DOM REFERENCES ---
        const getEl = id => document.getElementById(id);
        const channelGrid = getEl('channel-grid'), categoryList = getEl('category-list'), searchBar = getEl('search-bar'),
            playerWrapper = getEl('player-wrapper'), videojsPlayerWrapper = getEl('videojs-player-wrapper'),
            menuToggle = getEl('menu-toggle'), sidebar = getEl('sidebar'),
            mainContent = document.querySelector('main'), currentCategoryTitle = getEl('current-category-title'),
            loader = getEl('loader'), loadingText = document.querySelector('.loading-text'),
            progressCircle = document.querySelector('.progress-circle'),
            progressText = document.querySelector('.progress-circle-text'),
            welcomePopup = getEl('welcome-popup'), closePopupBtn = getEl('close-popup'),
            playerToggleBtn = getEl('player-toggle-btn'), viewToggleBtn = getEl('view-toggle-btn'),
            playerCloseBtn = getEl('player-close-btn'), videojsCloseBtn = getEl('videojs-close-btn'),
            langSwitchWrapper = document.querySelector('.lang-switch-wrapper'),
            themeSwitchWrapper = document.querySelector('.theme-switch-wrapper'),
            managePlaylistBtn = getEl('manage-playlist-btn'),
            playlistManagerPopup = getEl('playlist-manager-popup'),
            savePlaylistBtn = getEl('save-playlist-btn'),
            playlistNameInput = getEl('playlist-name-input'),
            playlistUrlInput = getEl('playlist-url-input'),
            playlistLogoInput = getEl('playlist-logo-input'),
            m3uFileInput = getEl('m3u-file-input'),
            savedPlaylistsList = getEl('saved-playlists-list');

        // --- 4. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            initPlayerToggle();
            initView();
            initLanguage();
            if (ENABLE_3D_BACKGROUND) initVanta();
            loadAllPlaylists();
            attachEventListeners();
            checkAndShowWelcomePopup();
        });

        function initVanta() {
            let color, bgColor;
            if (currentTheme === 'light') {
                color = 0x007bff;
                bgColor = 0xf0f2f5;
            } else if (currentTheme === 'bw') {
                color = 0xffffff;
                bgColor = 0x000000;
            } else {
                color = 0x7237df;
                bgColor = 0x101010;
            }
            vantaEffect = VANTA.NET({
                el: "#vanta-bg",
                mouseControls: true,
                touchControls: true,
                gyroControls: false,
                minHeight: 200.00,
                minWidth: 200.00,
                scale: 1.00,
                scaleMobile: 1.00,
                color: color,
                backgroundColor: bgColor
            });
        }

        function initTheme() {
            document.body.className = '';
            document.body.classList.add(`${currentTheme}-theme`);
            if (currentTheme === 'light' || currentTheme === 'bw') {
                themeSwitchWrapper.classList.add('active');
            } else {
                themeSwitchWrapper.classList.remove('active');
            }
        }

        function initPlayerToggle() {
            if (activePlayer === 'videojs') {
                playerToggleBtn.classList.add('active');
            } else {
                playerToggleBtn.classList.remove('active');
            }
        }

        function initView() {
            currentView = localStorage.getItem('streamverse_view') || 'grid';
            setView(currentView);
        }

        function initLanguage() {
            const lang = localStorage.getItem(LANGUAGE_KEY) || 'bn';
            setLanguage(lang);
            if (lang === 'en') {
                langSwitchWrapper.classList.add('active');
            } else {
                langSwitchWrapper.classList.remove('active');
            }
        }

        function checkAndShowWelcomePopup() {
            const welcomeShown = localStorage.getItem(WELCOME_MESSAGE_KEY);
            if (!welcomeShown) {
                welcomePopup.classList.add('show');
                localStorage.setItem(WELCOME_MESSAGE_KEY, 'true');
            }
        }
        
        async function loadAllPlaylists() {
            closePlayer();
            loader.style.display = 'flex';
            channelGrid.innerHTML = '';
            
            let allChannelsFromAllUrls = [];
            
            for (const playlist of savedPlaylists) {
                try {
                    const response = await fetch(playlist.url);
                    if (!response.ok) {
                        console.error(`Error fetching M3U from ${playlist.url}: HTTP status ${response.status}`);
                        continue;
                    }
                    const data = await response.text();
                    
                    const channels = parseM3U(data);
                    allChannelsFromAllUrls = allChannelsFromAllUrls.concat(channels);
                } catch (error) {
                    console.error(`Error fetching M3U file from ${playlist.url}:`, error);
                }
            }

            const uniqueChannels = {};
            allChannelsFromAllUrls.forEach(c => {
                const key = `${c.name}-${c.url}`;
                if (!uniqueChannels[key]) {
                    uniqueChannels[key] = c;
                }
            });
            let uniqueChannelsArray = Object.values(uniqueChannels);
            
            const totalChannels = uniqueChannelsArray.length;
            let checkedCount = 0;
            
            // NEW: Hide spinner, show progress circle
            loader.querySelector('.spinner')?.remove();
            progressCircle.style.display = 'flex';

            const channelsWithStatus = await Promise.all(uniqueChannelsArray.map(async channel => {
                const isWorking = await checkChannelStatus(channel.url);
                checkedCount++;
                const percent = Math.floor((checkedCount / totalChannels) * 100);
                
                // Update progress circle
                progressCircle.style.background = `radial-gradient(closest-side, var(--primary-bg) 79%, transparent 80% 100%), conic-gradient(var(--accent-color) ${percent}%, transparent 0%)`;
                progressText.textContent = `${percent}%`;

                return { ...channel, isWorking };
            }));

            allChannels = channelsWithStatus.sort((a, b) => b.isWorking - a.isWorking);

            renderCategories(allChannels);

            const lastCategory = localStorage.getItem('streamverse_last_category') || 'All';
            const categoryLink = categoryList.querySelector(`[data-category="${lastCategory}"]`);
            if (categoryLink) {
                categoryLink.click();
            } else {
                categoryList.querySelector('[data-category="All"]').click();
            }
            
            loadingText.textContent = translations[currentLang].checkingComplete;
            progressText.textContent = `100%`;
            setTimeout(() => {
                loader.style.display = 'none';
            }, 1000);
        }

        async function checkChannelStatus(url) {
            try {
                const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                return true;
            } catch (error) {
                return false;
            }
        }

        // --- 5. M3U PARSING & RENDERING ---
        function parseM3U(m3uText) {
            const lines = m3uText.split('\n');
            const channels = [];
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('#EXTINF:')) {
                    const infoLine = lines[i];
                    const urlLine = lines[i + 1] ? lines[i + 1].trim() : '';

                    if (urlLine && !urlLine.startsWith('#')) {
                        const nameMatch = infoLine.match(/tvg-name="([^"]*)"/);
                        const name = nameMatch ? nameMatch[1] : infoLine.substring(infoLine.lastIndexOf(',') + 1).trim();
                        const logoMatch = infoLine.match(/tvg-logo="([^"]*)"/);
                        const categoryMatch = infoLine.match(/group-title="([^"]*)"/);
                        
                        if (name) {
                            channels.push({
                                name: name,
                                logo: logoMatch ? logoMatch[1] : '',
                                category: categoryMatch ? categoryMatch[1] : 'Uncategorized',
                                url: urlLine
                            });
                        }
                    }
                }
            }
            return channels;
        }

        function createChannelCard(channel) {
            const isFavorite = favorites.includes(channel.name);
            const card = document.createElement('div');
            card.className = 'channel-card';
            card.dataset.url = channel.url;
            card.dataset.name = channel.name;
            
            if (channel.isWorking) {
                card.classList.add('working');
            }

            card.innerHTML = `
                <div class="channel-status-light"></div>
                <i class="share-icon fa-solid fa-share-nodes" title="${translations[currentLang].shareIconTitle}"></i>
                <i class="favorite-icon ${isFavorite ? 'fas fa-star favorited' : 'far fa-star'}" title="${translations[currentLang].favIconTitle}"></i>
                <div class="channel-logo-container">
                    <img src="${channel.logo || 'https://via.placeholder.com/150?text=No+Logo'}" alt="${channel.name}" class="channel-logo" onerror="this.src='https://via.placeholder.com/150?text=No+Logo';">
                </div>
                <div class="channel-name">${channel.name}</div>
            `;

            card.addEventListener('click', (e) => {
                if (!e.target.classList.contains('favorite-icon') && !e.target.classList.contains('share-icon') && !e.target.classList.contains('channel-status-light')) {
                    playChannel(channel);
                }
            });
            
            card.querySelector('.favorite-icon').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(channel, e.target);
            });

            card.querySelector('.share-icon').addEventListener('click', (e) => {
                e.stopPropagation();
                shareChannel(channel);
            });

            return card;
        }

        function renderChannels(channels) {
            channelGrid.innerHTML = '';
            if (channels.length === 0) {
                channelGrid.innerHTML = `<p class="status-message">${translations[currentLang].noChannelsFound}</p>`;
                return;
            }
            channels.forEach(channel => {
                channelGrid.appendChild(createChannelCard(channel));
            });
        }

        function renderCategories(channels) {
            const specialCategories = ['All', 'Favorites', 'Recently Watched'];
            const dynamicCategories = [...new Set(channels.map(c => c.category).filter(Boolean))].sort();
            const categories = [...specialCategories, ...dynamicCategories];
            
            categoryList.innerHTML = '';
            categories.forEach(category => {
                let icon;
                let displayCategory = category;
                switch(category) {
                    case 'All': icon = 'fa-globe'; displayCategory = translations[currentLang].all; break;
                    case 'Favorites': icon = 'fa-star'; displayCategory = translations[currentLang].favorites; break;
                    case 'Recently Watched': icon = 'fa-history'; displayCategory = translations[currentLang].recentlyWatched; break;
                    default: icon = 'fa-folder';
                }
                const li = document.createElement('li');
                li.innerHTML = `<a href="#" class="category-link" data-category="${category}"><i class="fa-solid ${icon}"></i> <span data-bn="${category}">${displayCategory}</span></a>`;
                categoryList.appendChild(li);
            });
        }

        function renderSavedPlaylists() {
            savedPlaylistsList.innerHTML = '';
            savedPlaylists.forEach((list, index) => {
                const li = document.createElement('li');
                li.dataset.index = index;
                li.innerHTML = `
                    <span>${list.name}</span>
                    <button class="delete-btn" data-index="${index}">&times;</button>
                `;
                li.querySelector('span').addEventListener('click', () => {
                    fetchAndParseM3U(list.url);
                    playlistManagerPopup.classList.remove('show');
                });
                li.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deletePlaylist(index);
                });
                savedPlaylistsList.appendChild(li);
            });
        }
        
        // --- 6. PLAYER LOGIC ---
        function playChannel(channel) {
            const playingChannelCard = document.querySelector('.channel-card.playing');
            if(playingChannelCard && playingChannelCard.dataset.name === channel.name) {
                return; // Prevent re-loading the same channel
            }
            
            if (mainContent.scrollTop > 100) {
                 mainContent.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            closePlayer();

            let playerToUse = activePlayer;
            const url = channel.url.toLowerCase();
            if (url.includes('.mkv') || url.includes('.mp4')) {
                playerToUse = 'videojs';
            }

            if (playerToUse === 'clappr') {
                playerWrapper.style.display = 'block';
                videojsPlayerWrapper.style.display = 'none';
                
                clapprPlayer = new Clappr.Player({
                    source: channel.url,
                    mimeType: 'application/x-mpegurl',
                    poster: channel.logo || 'https://via.placeholder.com/150?text=No+Logo',
                    height: '100%',
                    width: '100%',
                    autoPlay: true,
                    plugins: [
                        LevelSelector,
                        DashShakaPlayback,
                        ChromecastPlugin,
                        ClapprPip.PipButton,
                        ClapprPip.PipPlugin
                    ],
                    parentId: '#artplayer-container'
                });
            } else {
                playerWrapper.style.display = 'none';
                videojsPlayerWrapper.style.display = 'block';

                if (videojsPlayer) {
                    videojsPlayer.dispose();
                }

                videojsPlayer = videojs('my-player');

                let sourceType = 'video/mp4';
                if (url.includes('.m3u8')) {
                    sourceType = 'application/x-mpegURL';
                } else if (url.includes('.mpd')) {
                    sourceType = 'application/dash+xml';
                }
                
                videojsPlayer.src({ src: channel.url, type: sourceType });
                videojsPlayer.poster(channel.logo || 'https://via.placeholder.com/150?text=No+Logo');
                videojsPlayer.load();
                videojsPlayer.play();
            }
            
            updatePlayingIndicator(channel.name);
            addTorecentlyPlayed(channel);
        }

        function togglePlayer() {
            activePlayer = activePlayer === 'clappr' ? 'videojs' : 'clappr';
            localStorage.setItem(PLAYER_KEY, activePlayer);
            initPlayerToggle();
            
            const playingChannelCard = document.querySelector('.channel-card.playing');
            if (playingChannelCard) {
                const channelName = playingChannelCard.dataset.name;
                const channel = allChannels.find(c => c.name === channelName);
                if (channel) {
                    playChannel(channel);
                }
            } else {
                if (activePlayer === 'clappr') {
                    playerWrapper.style.display = 'block';
                    videojsPlayerWrapper.style.display = 'none';
                } else {
                    playerWrapper.style.display = 'none';
                    videojsPlayerWrapper.style.display = 'block';
                }
            }
        }


        function closePlayer() {
            if (clapprPlayer) {
                clapprPlayer.stop();
                clapprPlayer.destroy();
                clapprPlayer = null;
            }
            if (videojsPlayer) {
                videojsPlayer.pause();
                videojsPlayer.dispose();
                videojsPlayer = null;
            }
            playerWrapper.style.display = 'none';
            videojsPlayerWrapper.style.display = 'none';
            updatePlayingIndicator(null);
        }

        // --- 7. FEATURES ---
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem(LANGUAGE_KEY, lang);
            
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-bn]').forEach(el => {
                const key = el.getAttribute('data-bn');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            searchBar.placeholder = translations[lang].searchPlaceholder;
            getEl('close-popup').textContent = translations[lang].getStarted;
            playerCloseBtn.title = translations[lang].closePlayer;
            videojsCloseBtn.title = translations[lang].closePlayer;
            playerToggleBtn.title = translations[lang].playerToggleTitle;
            viewToggleBtn.title = translations[lang].viewToggleTitle;

            renderCategories(allChannels);
            filterChannels(categoryList.querySelector('.active')?.dataset.category || 'All', searchBar.value.toLowerCase());
            renderSavedPlaylists();
        }

        function toggleLanguage() {
            const newLang = currentLang === 'bn' ? 'en' : 'bn';
            setLanguage(newLang);
            langSwitchWrapper.classList.toggle('active');
        }

        function toggleTheme() {
            const themes = ['dark', 'light', 'bw'];
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const newTheme = themes[nextIndex];

            document.body.classList.remove(`${currentTheme}-theme`);
            document.body.classList.add(`${newTheme}-theme`);
            currentTheme = newTheme;
            localStorage.setItem(THEME_KEY, newTheme);

            if (newTheme === 'light' || newTheme === 'bw') {
                themeSwitchWrapper.classList.add('active');
            } else {
                themeSwitchWrapper.classList.remove('active');
            }

            if (vantaEffect) {
                let color, bgColor;
                if (newTheme === 'light') {
                    color = 0x007bff;
                    bgColor = 0xf0f2f5;
                } else if (newTheme === 'bw') {
                    color = 0xffffff;
                    bgColor = 0x000000;
                } else {
                    color = 0x7237df;
                    bgColor = 0x101010;
                }
                vantaEffect.setOptions({ color, backgroundColor: bgColor });
            }
        }
        
        function toggleFavorite(channel, iconElement) {
            const index = favorites.indexOf(channel.name);
            if (index > -1) {
                favorites.splice(index, 1);
                iconElement.classList.replace('fas', 'far');
                iconElement.classList.remove('favorited');
            } else {
                favorites.push(channel.name);
                iconElement.classList.replace('far', 'fas');
                iconElement.classList.add('favorited');
            }
            localStorage.setItem('streamverse_favorites', JSON.stringify(favorites));
            if (categoryList.querySelector('.active')?.dataset.category === 'Favorites') {
                filterChannels('Favorites', searchBar.value.toLowerCase());
            }
        }

        function shareChannel(channel) {
            const url = `${window.location.origin}${window.location.pathname}?channel=${encodeURIComponent(channel.name)}`;
            navigator.clipboard.writeText(url)
                .then(() => {
                    alert(`${translations[currentLang].channelCopySuccess}\n${url}`);
                })
                .catch(err => {
                    console.error('Failed to copy text: ', err);
                });
        }

        function addTorecentlyPlayed(channel) {
            recentlyPlayed = recentlyPlayed.filter(c => c.name !== channel.name);
            recentlyPlayed.unshift(channel);
            if (recentlyPlayed.length > 20) recentlyPlayed.pop();
            localStorage.setItem('streamverse_recents', JSON.stringify(recentlyPlayed));
        }

        function updatePlayingIndicator(channelName) {
            document.querySelectorAll('.channel-card').forEach(card => {
                card.classList.toggle('playing', card.dataset.name === channelName);
            });
        }

        function setView(view) {
            currentView = view;
            channelGrid.className = `grid-view`;
            if (view === 'grid') {
                viewToggleBtn.innerHTML = '<i class="fa-solid fa-list"></i>';
                viewToggleBtn.title = translations[currentLang].viewToggleTitle;
            } else {
                viewToggleBtn.innerHTML = '<i class="fa-solid fa-grip"></i>';
                viewToggleBtn.title = translations[currentLang].viewToggleTitle;
                channelGrid.className = `list-view`;
            }
            localStorage.setItem('streamverse_view', view);
        }

        function savePlaylist() {
            const name = playlistNameInput.value.trim();
            const url = playlistUrlInput.value.trim();
            const logo = playlistLogoInput.value.trim();

            if (!name || !url) {
                alert(translations[currentLang].inputError);
                return;
            }

            savedPlaylists.push({ name, url, logo });
            localStorage.setItem(SAVED_PLAYLISTS_KEY, JSON.stringify(savedPlaylists));
            renderSavedPlaylists();
            playlistNameInput.value = '';
            playlistUrlInput.value = '';
            playlistLogoInput.value = '';
            alert(translations[currentLang].urlSaved);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const name = file.name.replace(/\.[^/.]+$/, "");
                savedPlaylists.push({ name, url: URL.createObjectURL(new Blob([content], {type: 'application/x-mpegURL'})) });
                localStorage.setItem(SAVED_PLAYLISTS_KEY, JSON.stringify(savedPlaylists));
                renderSavedPlaylists();
                alert(translations[currentLang].fileUploadSuccess);
            };
            reader.readAsText(file);
        }

        function deletePlaylist(index) {
            if (confirm("Are you sure you want to delete this playlist?")) {
                savedPlaylists.splice(index, 1);
                localStorage.setItem(SAVED_PLAYLISTS_KEY, JSON.stringify(savedPlaylists));
                renderSavedPlaylists();
            }
        }
        
        // --- 8. EVENT LISTENERS & FILTERS ---
        function attachEventListeners() {
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                mainContent.classList.toggle('sidebar-collapsed');
            });
            
            document.addEventListener('click', (e) => {
                if(sidebar.classList.contains('open') && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('open');
                    mainContent.classList.remove('sidebar-collapsed');
                }
            });

            closePopupBtn.addEventListener('click', () => {
                welcomePopup.classList.remove('show');
            });

            searchBar.addEventListener('input', e => {
                const category = categoryList.querySelector('.active')?.dataset.category || 'All';
                filterChannels(category, e.target.value.toLowerCase());
            });

            categoryList.addEventListener('click', e => {
                const link = e.target.closest('.category-link');
                if (link) {
                    e.preventDefault();
                    const category = link.dataset.category;
                    categoryList.querySelectorAll('.active').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    currentCategoryTitle.textContent = translations[currentLang][category.toLowerCase()] || category;
                    searchBar.value = '';
                    filterChannels(category, '');
                    localStorage.setItem('streamverse_last_category', category);
                    if (window.innerWidth <= 768) sidebar.classList.remove('open');
                }
            });

            viewToggleBtn.addEventListener('click', () => {
                setView(currentView === 'grid' ? 'list' : 'grid');
            });
            
            langSwitchWrapper.addEventListener('click', toggleLanguage);
            themeSwitchWrapper.addEventListener('click', toggleTheme);

            playerToggleBtn.addEventListener('click', togglePlayer);
            playerCloseBtn.addEventListener('click', closePlayer);
            videojsCloseBtn.addEventListener('click', closePlayer);
            
            managePlaylistBtn.addEventListener('click', (e) => {
                e.preventDefault();
                playlistManagerPopup.classList.add('show');
                renderSavedPlaylists();
            });
            document.querySelectorAll('.popup-close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    playlistManagerPopup.classList.remove('show');
                });
            });
            savePlaylistBtn.addEventListener('click', savePlaylist);
            m3uFileInput.addEventListener('change', handleFileUpload);
        }

        function filterChannels(category, searchTerm) {
            let filtered = [];
            switch(category) {
                case 'All': filtered = allChannels; break;
                case 'Favorites': filtered = allChannels.filter(c => favorites.includes(c.name)); break;
                case 'Recently Watched':
                    const recentNames = recentlyPlayed.map(c => c.name);
                    filtered = allChannels.filter(c => recentNames.includes(c.name))
                                .sort((a, b) => recentNames.indexOf(a.name) - recentNames.indexOf(b.name));
                    break;
                default: filtered = allChannels.filter(c => c.category === category);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(c => c.name.toLowerCase().includes(searchTerm));
            }
            renderChannels(filtered);
        }
    </script>
</body>
</html>
